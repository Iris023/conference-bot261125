const { Telegraf, Markup } = require('telegraf');
const fs = require('fs');
const path = require('path');

const REG_FILE = path.join(__dirname, 'registrations.csv');

// –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –∏–Ω–∞—á–µ —Å–æ–∑–¥–∞—ë–º —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
function ensureRegFile() {
  if (!fs.existsSync(REG_FILE)) {
    const header = 'Timestamp;TelegramID;Username;INN;FIO;Phone;Email;Consent\n';
    fs.writeFileSync(REG_FILE, header, 'utf8');
  }
}

ensureRegFile();


function isAlreadyRegistered(phone) {
  return new Promise((resolve, reject) => {
    fs.readFile(REG_FILE, 'utf8', (err, data) => {
      if (err) return reject(err);

      const lines = data.split('\n').filter(Boolean);

      // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞)
      for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(';');
        const rowPhone = (cols[5] || '').trim(); // –∫–æ–ª–æ–Ω–∫–∞ Phone

        if (rowPhone === phone) {
          return resolve(true);
        }
      }

      resolve(false);
    });
  });
}

function appendRegistrationRow({ telegramId, username, inn, fio, phone, email, consent }) {
  return new Promise((resolve, reject) => {
    const now = new Date().toISOString();
    const line = [
      now,
      String(telegramId),
      username || '',
      inn,
      fio,
      phone,
      email,
      consent || ''
    ].join(';') + '\n';

    fs.appendFile(REG_FILE, line, 'utf8', (err) => {
      if (err) return reject(err);
      resolve();
    });
  });
}



// ‚¨á‚¨á‚¨á –≤—Å—Ç–∞–≤—å —Å—é–¥–∞ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞ –æ—Ç BotFather
const BOT_TOKEN = '8447521660:AAH7pVxRPBzibHjyzIj9wZfF6PbW5sBuGpM';

if (!BOT_TOKEN) {
  console.error('–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ –±–æ—Ç–∞. –ü—Ä–æ–≤–µ—Ä—å BOT_TOKEN.');
  process.exit(1);
}

const bot = new Telegraf(BOT_TOKEN);

// –ß—Ç–æ–±—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å, –Ω–∞ –∫–∞–∫–æ–º —à–∞–≥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
const userStates = {};

// –£–¥–∞–ª—è–µ—Ç –∫–Ω–æ–ø–∫–∏, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç inline-–∫–Ω–æ–ø–∫—É
async function clearInlineButtons(ctx) {
  try {
    await ctx.answerCbQuery();
  } catch (e) {
    // –∏–Ω–æ–≥–¥–∞ Telegram —É–∂–µ –æ—Ç–≤–µ—Ç–∏–ª ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
  }

  try {
    await ctx.editMessageReplyMarkup({ inline_keyboard: [] });
  } catch (e) {
    // –µ—Å–ª–∏ –Ω–µ–ª—å–∑—è —É–±—Ä–∞—Ç—å –∫–Ω–æ–ø–∫–∏ ‚Äî –Ω–µ —Å—Ç—Ä–∞—à–Ω–æ
  }
}


// /start ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –∫–Ω–æ–ø–∫–∏
bot.start(async (ctx) => {
  const userId = ctx.from.id;
  delete userStates[userId];

  const text =
    '<b>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!</b>\n' +
    '–†–∞–¥—ã –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –≤–∞—Å –≤ —á–∞—Ç-–±–æ—Ç–µ –ö–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏ ¬´–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É –º–æ—Ä—è¬ª, ' +
    '–ø–æ—Å–≤—è—â–µ–Ω–Ω–æ–π –∏—Ç–æ–≥–∞–º –∏ –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞–º —Ä–∞–∑–≤–∏—Ç–∏—è –±–µ—Ä–µ–∂–ª–∏–≤–æ–≥–æ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞ –≤ –î–∞–ª—å–Ω–µ–≤–æ—Å—Ç–æ—á–Ω–æ–º —Ä–µ–≥–∏–æ–Ω–µ.\n\n' +
    '<b>–û –ú–ï–†–û–ü–†–ò–Ø–¢–ò–ò</b>\n' +
    '–î–∞—Ç–∞: 26 –Ω–æ—è–±—Ä—è 2025 –≥. (—Å—Ä–µ–¥–∞)\n' +
    '–ú–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è: —É–ª. –ë–∞—Ç–∞—Ä–µ–π–Ω–∞—è, 4, —Ñ–∏–ª–∏–∞–ª –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∞ ¬´–†–æ—Å—Å–∏—è¬ª –≤ –ü—Ä–∏–º–æ—Ä—Å–∫–æ–º –∫—Ä–∞–µ (–±—ã–≤—à–∏–π –û–∫–µ–∞–Ω–∞—Ä–∏—É–º)\n\n' +
    '<b>–ö–ª—é—á–µ–≤—ã–µ —Ç–µ–º—ã –¥–Ω—è:</b>\n' +
    '‚Ä¢ –ù–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ –ª—É—á—à–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –∏ —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤ ¬´–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ç—Ä—É–¥–∞¬ª.\n' +
    '‚Ä¢ –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è —É—Å–ø–µ—à–Ω—ã—Ö –∫–µ–π—Å–æ–≤ –∏ –ª—É—á—à–∏—Ö –ø—Ä–∞–∫—Ç–∏–∫ –ø–æ–≤—ã—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –≤ –∫–æ–º–ø–∞–Ω–∏—è—Ö –ü—Ä–∏–º–æ—Ä—å—è.\n' +
    '‚Ä¢ –û–±–º–µ–Ω –æ–ø—ã—Ç–æ–º –¥–ª—è —Ä–æ—Å—Ç–∞ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –≤–∞—à–∏—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π.\n' +
    '‚Ä¢ –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –º–µ—Ä—ã –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏—á–µ—Å—Ç–≤–∞ —Å –æ—Ä–≥–∞–Ω–∞–º–∏ –≤–ª–∞—Å—Ç–∏.\n\n' +
    '<b>–£—á–∞—Å—Ç–Ω–∏–∫–∏ –≤—Å—Ç—Ä–µ—á–∏:</b>\n' +
    '–ì—É–±–µ—Ä–Ω–∞—Ç–æ—Ä –ü–ö –û.–ù. –ö–æ–∂–µ–º—è–∫–æ, –∑–∞–º–ø—Ä–µ–¥ –ø—Ä–∞–≤–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –ü–ö –ù.–ò. –°—Ç–µ—Ü–∫–æ, –º–∏–Ω–∏—Å—Ç—Ä —ç–∫–æ–Ω–æ–º–∏–∫–∏ –ü–ö –ê.–ò. –ë–ª–æ—Ö–∏–Ω, ' +
    '—Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª–∏ —Ü–µ–Ω—Ç—Ä–∞ ¬´–ú–æ–π –±–∏–∑–Ω–µ—Å¬ª, –†–¶–ö –∏ –≤–µ–¥—É—â–∏—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π –∫—Ä–∞—è.\n\n' +
    '–£—Å–ª–æ–≤–∏—è —É—á–∞—Å—Ç–∏—è: <b>–±–µ—Å–ø–ª–∞—Ç–Ω–æ</b>.\n' +
    '–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚¨á';

  await ctx.reply(text, {
    parse_mode: 'HTML',
    reply_markup: {
      remove_keyboard: true
    }
  });

  return ctx.reply(
    '–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:',
    Markup.inlineKeyboard([
      [Markup.button.callback('üìù –ü—Ä–æ–π—Ç–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é', 'register')],
      [Markup.button.callback('üìã –ü—Ä–æ–≥—Ä–∞–º–º–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è', 'program')],
    ])
  );
});

// –ù–∞—á–∞–ª–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
bot.action('register', async (ctx) => {
  await clearInlineButtons(ctx);

  const userId = ctx.from.id;

  userStates[userId] = {
    step: 'consent',
    data: {}
  };

  await ctx.reply(
    '–î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—é ¬´–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É –º–æ—Ä—è¬ª ' +
    '–ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –ò–ù–ù –∫–æ–º–ø–∞–Ω–∏–∏, –§–ò–û –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è, –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –∞–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã.\n\n' +
    '–ù–∞–∂–∏–º–∞—è ¬´–°–æ–≥–ª–∞—Å–µ–Ω¬ª, –≤—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ, —á—Ç–æ –¥–∞—ë—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É —ç—Ç–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ' +
    '–æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞–º–∏ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏ –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ —Ü–µ–ª—è—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.',
    {
      reply_markup: {
        inline_keyboard: [
          [
            { text: '‚úÖ –°–æ–≥–ª–∞—Å–µ–Ω', callback_data: 'consent_yes' },
            { text: '‚ùå –ù–µ —Å–æ–≥–ª–∞—Å–µ–Ω', callback_data: 'consent_no' }
          ]
        ]
      }
    }
  );
});

bot.action('consent_yes', async (ctx) => {
  await clearInlineButtons(ctx);

  const userId = ctx.from.id;
  const state = userStates[userId];

  if (!state || state.step !== 'consent') {
    return;
  }

  state.data.consent = 'yes_v1'; // —Ñ–∏–∫—Å–∏—Ä—É–µ–º –≤–µ—Ä—Å–∏—é —Å–æ–≥–ª–∞—Å–∏—è
  state.step = 'inn';

  await ctx.reply(
    '–°–ø–∞—Å–∏–±–æ, —Å–æ–≥–ª–∞—Å–∏–µ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–æ ‚úÖ\n\n' +
    '–í–≤–µ–¥–∏—Ç–µ –ò–ù–ù –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ (10 –∏–ª–∏ 12 —Ü–∏—Ñ—Ä):',
    {
      reply_markup: { remove_keyboard: true }
    }
  );
});

bot.action('consent_no', async (ctx) => {
  await clearInlineButtons(ctx);

  const userId = ctx.from.id;
  const state = userStates[userId];

  if (state) {
    delete userStates[userId];
  }

  await ctx.reply(
    '–ë–µ–∑ —Å–æ–≥–ª–∞—Å–∏—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —è –Ω–µ –º–æ–≥—É –ø—Ä–æ–≤–µ—Å—Ç–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.\n\n' +
    '–ï—Å–ª–∏ –≤—ã –ø–µ—Ä–µ–¥—É–º–∞–µ—Ç–µ ‚Äî –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:',
    Markup.inlineKeyboard([
      [Markup.button.callback('üìù –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è', 'register')],
      [Markup.button.callback('üìã –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏', 'program')],
    ])
  );
});

bot.action('restart', async (ctx) => {
  await clearInlineButtons(ctx);

  const userId = ctx.from.id;
  delete userStates[userId]; // —Å–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è

  userStates[userId] = {
    step: 'consent',
    data: {}
  };

  await ctx.reply(
    '–î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω—ë–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ.\n\n' +
    '–î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—é ¬´–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É –º–æ—Ä—è¬ª ' +
    '–º–Ω–µ –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –ò–ù–ù –∫–æ–º–ø–∞–Ω–∏–∏, –§–ò–û –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è, –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏ –∞–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã.\n\n' +
    '–ù–∞–∂–∏–º–∞—è ¬´–°–æ–≥–ª–∞—Å–µ–Ω¬ª, –≤—ã –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ, —á—Ç–æ –¥–∞—ë—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É —ç—Ç–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.',
    {
      reply_markup: {
        inline_keyboard: [
          [
            { text: '‚úÖ –°–æ–≥–ª–∞—Å–µ–Ω', callback_data: 'consent_yes' },
            { text: '‚ùå –ù–µ —Å–æ–≥–ª–∞—Å–µ–Ω', callback_data: 'consent_no' }
          ]
        ]
      }
    }
  );
});


// –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏
bot.action('program', async (ctx) => {
  await clearInlineButtons(ctx);

  const text =
    '<b>üìã –ü—Ä–æ–≥—Ä–∞–º–º–∞ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏–∏ ¬´–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —É –º–æ—Ä—è¬ª</b>\n\n' +
    '<b>10:00‚Äì10:30</b> ‚Äî –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤.\n' +
    '<b>10:30‚Äì11:00</b> ‚Äî –¢–æ—Ä–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ –æ—Ç–∫—Ä—ã—Ç–∏–µ.\n\n' +
    '<b>11:00‚Äì13:00 ‚Äî –ü–ª–µ–Ω–∞—Ä–Ω–∞—è —Å–µ—Å—Å–∏—è</b>\n' +
    '‚Ä¢ –ò—Ç–æ–≥–∏ –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞\n' +
    '‚Ä¢ –ó–∞–¥–∞—á–∏ —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞\n' +
    '‚Ä¢ –ú–µ—Ä—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π\n' +
    '‚Ä¢ –í—ã—Å—Ç—É–ø–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞\n' +
    '‚Ä¢ –ù–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ\n\n' +
    '<b>13:00‚Äì14:00</b> ‚Äî –ö–æ—Ñ–µ-–±—Ä–µ–π–∫ –∏ —ç–∫—Å–∫—É—Ä—Å–∏—è –ø–æ —Ü–µ–Ω—Ç—Ä—É.\n\n' +
    '<b>14:00‚Äì17:30 ‚Äî –î–µ–ª–æ–≤–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</b>\n' +
    '<u>–ë–æ–ª—å—à–æ–π –∑–∞–ª:</u>\n' +
    '‚Ä¢ –ö—Ä—É–≥–ª—ã–π —Å—Ç–æ–ª —Å —ç–∫—Å–ø–µ—Ä—Ç–∞–º–∏\n' +
    '‚Ä¢ –õ–µ–∫—Ü–∏—è: ¬´–í–ª–∏—è–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –ë–ü¬ª\n' +
    '‚Ä¢ –ü—Ä–∞–∫—Ç–∏–∫—É–º: ¬´–†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º¬ª\n\n' +
    '<u>–ú–∞–ª—ã–π –∑–∞–ª:</u>\n' +
    '‚Ä¢ –õ–µ–∫—Ü–∏—è: ¬´–°–∏—Å—Ç–µ–º–∞ –æ–±—É—á–µ–Ω–∏—è –ë–ü¬ª\n' +
    '‚Ä¢ –õ–µ–∫—Ü–∏—è: ¬´–ú–∞—Ç—Ä–∏—Ü–∞ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π¬ª';

  await ctx.reply(text, { parse_mode: 'HTML' });

  // –ï—Å–ª–∏ —Ö–æ—á–µ—à—å –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å PDF:
  await ctx.replyWithDocument({ source: 'plan.pdf' });

  //–∫–Ω–æ–ø–∫–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
  await ctx.reply(
    '–ï—Å–ª–∏ –≤—ã –≥–æ—Ç–æ–≤—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—é ‚Äî –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ:',
    Markup.inlineKeyboard([
      [Markup.button.callback('üìù –ü—Ä–æ–π—Ç–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é', 'register')],
    ])
  );
});



// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Å–µ—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏)
bot.on('text', async (ctx) => {
  const userId = ctx.from.id;
  const state = userStates[userId];

  // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
  if (!state) return;

  const text = ctx.message.text.trim();

  // --- –®–ê–ì 1: –ò–ù–ù ---
  if (state.step === 'inn') {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ò–ù–ù –Ω–∞ —Ü–∏—Ñ—Ä—ã –∏ –¥–ª–∏–Ω—É
    const innRegex = /^\d{10}(\d{2})?$/;

    if (!innRegex.test(text)) {
      return ctx.reply('–ò–ù–ù –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –∏ –±—ã—Ç—å –¥–ª–∏–Ω–æ–π 10 –∏–ª–∏ 12 —Å–∏–º–≤–æ–ª–æ–≤. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:');
    }

    state.data.inn = text;
    state.step = 'fio';

    return ctx.reply('–í–≤–µ–¥–∏—Ç–µ –§–ò–û –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—è (–ø–æ–ª–Ω–æ—Å—Ç—å—é):');
  }

// --- –®–ê–ì 2: –§–ò–û ---
if (state.step === 'fio') {
  if (text.length < 5) {
    return ctx.reply('–§–ò–û –≤—ã–≥–ª—è–¥–∏—Ç —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–º. –í–≤–µ–¥–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ª–Ω–æ—Å—Ç—å—é:');
  }

  state.data.fio = text;
  state.step = 'phone';

  return ctx.reply(
    '–¢–µ–ø–µ—Ä—å —É–∫–∞–∂–µ–º –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.\n\n' +
    '–í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–≤–æ–π –Ω–æ–º–µ—Ä –∏–∑ Telegram –∏–ª–∏ –≤–≤–µ—Å—Ç–∏ –µ–≥–æ –≤—Ä—É—á–Ω—É—é –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7XXXXXXXXXX:',
    {
      reply_markup: {
        keyboard: [
          [{ text: 'üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–æ–π –∫–æ–Ω—Ç–∞–∫—Ç', request_contact: true }],
          [{ text: '‚úèÔ∏è –í–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä –≤—Ä—É—á–Ω—É—é' }]
        ],
        resize_keyboard: true,
        one_time_keyboard: true
      }
    }
  );
}

// --- –®–ê–ì 3: –¢–ï–õ–ï–§–û–ù  ---
if (state.step === 'phone') {
  // –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –Ω–∞–∂–∞–ª "‚úèÔ∏è –í–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä –≤—Ä—É—á–Ω—É—é"
  if (text === '‚úèÔ∏è –í–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä –≤—Ä—É—á–Ω—É—é') {
    return ctx.reply('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7XXXXXXXXXX:');
  }

  const phoneRegex = /^\+7\d{10}$/;

  // –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ‚Üí –æ—à–∏–±–∫–∞ + –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞
  if (!phoneRegex.test(text)) {
    return ctx.reply(
      '–ù–æ–º–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ +7XXXXXXXXXX.\n' +
      '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ ¬´üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–æ–π –∫–æ–Ω—Ç–∞–∫—Ç¬ª.',
      {
        reply_markup: {
          keyboard: [
            [{ text: 'üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–æ–π –∫–æ–Ω—Ç–∞–∫—Ç', request_contact: true }],
            [{ text: '‚úèÔ∏è –í–≤–µ—Å—Ç–∏ –Ω–æ–º–µ—Ä –≤—Ä—É—á–Ω—É—é' }]
          ],
          resize_keyboard: true
        }
      }
    );
  }

  // üí• –í–ê–ñ–ù–û: –°–†–ê–ó–£ –ü–†–û–í–ï–†–Ø–ï–ú –î–£–ë–õ–ò–ö–ê–¢ –ü–û –¢–ï–õ–ï–§–û–ù–£!
  const already = await isAlreadyRegistered(text);
if (already) {
  delete userStates[userId];

  await ctx.reply(
    '–ü–æ—Ö–æ–∂–µ, —É—á–∞—Å—Ç–Ω–∏–∫ —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.\n' +
    '–ü–æ–≤—Ç–æ—Ä–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.',
    {
      reply_markup: { remove_keyboard: true }
    }
  );

  await ctx.reply(
    '–í—ã –º–æ–∂–µ—Ç–µ:',
    Markup.inlineKeyboard([
      [Markup.button.callback('üîÅ –ù–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞', 'restart')],
      [Markup.button.callback('üìã –ü—Ä–æ–≥—Ä–∞–º–º–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è', 'program')]
    ])
  );

  return;
}




  // –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –Ω–æ–≤—ã–π ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏ –∏–¥—ë–º –¥–∞–ª—å—à–µ
  state.data.phone = text;
  state.step = 'email';

  await ctx.reply('–¢–µ–ª–µ—Ñ–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω ‚úÖ', {
    reply_markup: { remove_keyboard: true }
  });

  return ctx.reply('–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã:');
}


  // --- –®–ê–ì 4: EMAIL ---
  if (state.step === 'email') {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  if (!emailRegex.test(text)) {
    return ctx.reply(
      '–ü–æ—Ö–æ–∂–µ, –∞–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã —É–∫–∞–∑–∞–Ω –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.\n' +
      '–í–≤–µ–¥–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–µ–π—Å—Ç–≤—É—é—â–∏–π email (–Ω–∞–ø—Ä–∏–º–µ—Ä: example@mail.ru):'
    );
  }

  state.data.email = text.trim();

  const { inn, fio, phone, email } = state.data;

  try {
    // 1) –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω –≤ —Ñ–∞–π–ª–µ
    const already = await isAlreadyRegistered(phone);

    if (already) {
      await ctx.reply(
        '–ü–æ—Ö–æ–∂–µ, —É—á–∞—Å—Ç–Ω–∏–∫ —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—é.\n' +
        '–ü–æ–≤—Ç–æ—Ä–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.'
      );
      delete userStates[userId];
      return;
    }

    // 2) –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –≤ CSV
    await appendRegistrationRow({
      telegramId: ctx.from.id,
      username: ctx.from.username || '',
      inn,
      fio,
      phone,
      email,
      consent: state.data.consent || 'yes_v1',
    });


    await ctx.reply('–°–ø–∞—Å–∏–±–æ! –í–∞—à–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–∞ –∫–æ–Ω—Ñ–µ—Ä–µ–Ω—Ü–∏—é –ø—Ä–∏–Ω—è—Ç–∞ ‚úÖ');

  } catch (err) {
    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å —Ñ–∞–π–ª–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π:', err);
    await ctx.reply(
      '–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö.\n' +
      '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –æ—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä–∞–º–∏.'
    );
  }

  delete userStates[userId];
  return;
}




});


// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞ (–∫–Ω–æ–ø–∫–∞ "üì± –û—Ç–ø—Ä–∞–≤–∏—Ç—å –º–æ–π –∫–æ–Ω—Ç–∞–∫—Ç")
bot.on('contact', async (ctx) => {
  const userId = ctx.from.id;
  const state = userStates[userId];
if (state.step === 'phone') {
  const contact = ctx.message.contact;

  if (!contact || !contact.phone_number) {
    return ctx.reply('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
  }

  let phone = contact.phone_number.trim().replace(/\D/g, '');

  if (phone.startsWith('8')) phone = '7' + phone.slice(1);
  if (!phone.startsWith('7')) {
    return ctx.reply('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ä–æ—Å—Å–∏–π—Å–∫–∏–π –Ω–æ–º–µ—Ä –≤—Ä—É—á–Ω—É—é (+7...).');
  }

  phone = '+7' + phone.slice(1);

  // üí• –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥—É–±–ª–µ–π –ø–æ –Ω–æ–º–µ—Ä—É!
  const already = await isAlreadyRegistered(phone);
if (already) {
  delete userStates[userId];

  await ctx.reply(
    '–ü–æ—Ö–æ–∂–µ, —É—á–∞—Å—Ç–Ω–∏–∫ —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.\n' +
    '–ü–æ–≤—Ç–æ—Ä–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.',
    {
      reply_markup: { remove_keyboard: true }
    }
  );

  await ctx.reply(
    '–í—ã –º–æ–∂–µ—Ç–µ:',
    Markup.inlineKeyboard([
      [Markup.button.callback('üîÅ –ù–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞', 'restart')],
      [Markup.button.callback('üìã –ü—Ä–æ–≥—Ä–∞–º–º–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è', 'program')]
    ])
  );

  return;
}




  // –ï—Å–ª–∏ –Ω–æ–º–µ—Ä–∞ –Ω–µ—Ç –≤ –±–∞–∑–µ ‚Üí —Å–æ—Ö—Ä–∞–Ω—è–µ–º
  state.data.phone = phone;
  state.step = 'email';

  await ctx.reply(`–¢–µ–ª–µ—Ñ–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω: ${phone} ‚úÖ`, {
    reply_markup: { remove_keyboard: true }
  });

  return ctx.reply('–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –ø–æ—á—Ç—ã:');
}

});



// –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
bot.launch();
console.log('–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω.');

// –ê–∫–∫—É—Ä–∞—Ç–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ Ctrl+C –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é –ø—Ä–æ—Ü–µ—Å—Å–∞
process.once('SIGINT', () => {
  console.log('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞ (SIGINT)...');
  bot.stop('SIGINT');
});
process.once('SIGTERM', () => {
  console.log('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞ (SIGTERM)...');
  bot.stop('SIGTERM');
});

